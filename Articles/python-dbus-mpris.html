<!doctype html>
<html>
  <head>
    <title>Connect and control your media player with python and dbus using MPRIS</title>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="description" content="Tutorial on how to use python to control a media player like VLC, or Audacious, or Clementine using dbus and the MPRIS specification.">
    <meta name="author" content="Amish Naidu">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300">
  </head>
  <body>
    <div id="header">
      <h1>
        Amish Naidu
      </h1>
      <div id="subtext">
        amhndu.github.io
      </div>
      <div id="navbar">
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="../projects.html">Projects</a></li>
          <li><a href="../articles.html" id="selected">Articles</a></li>
        </ul>
      </div>
    </div>
    <div id="content">
      <h2>Connect and control your media player with python and dbus using MPRIS</h2>
      In this guide we'll be using Python 3 although you may be able to apply this to Python 2.4 and above with minor adjustments. Since D-Bus is only used by Linux and BSD distributions, needless to say, this will only work with *nix systems<br>
      We'll connect to a media player which implements the <b>Media Player Remote Interfacing Specification</b> or MPRIS for short. Most popular players like Audacious, Amarok, Clementine, VLC etc will work.<br>
      This can be useful for purposes like priting metadata of the current track on <a href="../Projects/conky-cards.html">conky</a> and controling the player with widgets. For a particular example, Clementine, for some reason would not bind the media keys on my keyboard for global shortcuts, so with the help of a python script I made the keybindings directly with the window manager and my script.<br>
      This guide follows the python documentation convention for code.<br>
      <span class="inline-pre">&gt;&gt;&gt;</span> imples the python interpreter prompt, <span class="inline-pre">...</span> imples a multiline prompt continuing from the previous command and a line with neither of the prompts implies output, therefore, if you are copy-pasting code, you will have to copy a line at a time.
      Also, you should be versed in python terminology and should have some basic knowledge of Python.<br>
      Let's get started, launch a terminal with the python interpreter and put on some music!
      <h3>D-Bus Basics</h3>
      DBus is a message bus system which allows <i>Inter-process communication</i> i.e it allows different processes to talk to each other and even different instances of the same application.<br>
      The <i>dbus daemon</i> runs in the background allowing applications to connect to this <i>daemon</i> using the <i>libdbus</i> library and it's wrappers for different languages and frameworks.<br>
      Communication is done using a <b>bus</b>, each application is granted a unique name like <i>:1-45</i> or <i>:2-16</i>) when it connects to the bus.
      The application may request a familiar bus name (based on the <a href="https://en.wikipedia.org/wiki/Reverse_domain_name_notation">Reversed domain name</a> convention) e.g. <i>org.freedesktop.PowerManagement, com.Skype.API and org.mpris.MediaPlayer2.clementine</i><br>
      Each application or service can have multiple <b>object paths</b> representing a unique object within the application, they look like filesystem paths e.g. <i>/org/mpris/MediaPlayer2</i><br>
      <b>Interfaces</b> act like namespaces, within which <b>Methods</b> and <b>Signals</b> are defined.<br>
      Therefore, to make a method call you need:
      <ul>
        <li>Bus name</li>
        <li>Object path</li>
        <li>Interface name</li>
      </ul>
      Some applications may also have <b>Properties</b>, these properties could be set or retrieved through the <i>org.freedesktop.DBus.Properties</i> interface. More on this later.<br>
      There are mainly two two buses, the <b>Session Bus</b> and the <b>System Bus</b>
      The system bus is a session independent bus which is used by system services such as <i>udev</i> or <i>NetworkManager</i> whereas a session bus is unique for the current user session.
      It is used by desktop applications and it is this bus we will be interested in for this guide.<br>
      <h3>Connecting to the D-Bus daemon with Python</h3>
<pre>
&gt;&gt;&gt; import dbus
&gt;&gt;&gt; bus = dbus.SessionBus()
</pre>
      In the first line, we import the dbus module and in the second line we make an object of the class <b>SessionBus</b>.<br>
      This class will make us a connection with the session bus granting us a unique name which can be retrieved with the <span class="inline-pre">get_unique_name()</span> method.
      Try this
<pre>
&gt;&gt;&gt; bus.get_unique_name()
':1.113'
</pre>
      Your unique name will vary.<br>
      We can also request a name with the method <span class="inline-pre">request_name()</span> following the reverse domain convention.
<pre>
&gt;&gt;&gt; bus.request_name('io.github.amhndu.test')
</pre>
      A return value of 1 implies that you have succesfully acquired the name.<br>
      This class also allows us to list all the services/applications registered with the session bus:
<pre>
&gt;&gt;&gt; for service in bus.list_names():
...     print(service)
</pre>
      In the list you'll also see the name we requested above.<br>
      You can even expose your python application with an API on dbus with this module but it is beyond this article's scope.<br>
      Note: D-bus, unlike python, is strongly typed and the python dbus library has wrapper classes for datatypes to faciliate interfacing dbus methods and python, thus the methods in the dbus module return these wrapper classes which can be implicitly converted to python native data types.
      <h3>Connecting to the player</h3>
      The <a href="#mpris-spec">MPRIS 2.0</a> spec defines that the player must request a name prefixed with <i>org.mpris.MediaPlayer2</i>.
      Therefore a player can have a name of form <i>org.mpris.MediaPlayer2.clementine</i> where the name ends the the name of the player.<br>
      To find out all the services of this form we can use regex to filter it out:
<pre>
&gt;&gt;&gt; import re
&gt;&gt;&gt; for service in bus.list_names():
...     if re.match('org.mpris.MediaPlayer2.', service):
...             print(service)
...
org.mpris.MediaPlayer2.clementine
org.mpris.MediaPlayer2.vlc
</pre>
      As you can see in output, I had two players --vlc and clementine-- opened.<br>
      Once you've found the service name of your player, we can get an object:
<pre>
&gt;&gt;&gt; player = dbus.SessionBus().get_object('org.mpris.MediaPlayer2.clementine', '/org/mpris/MediaPlayer2')
</pre>
      The first argument to <span class="inline-pre">get_object()</span> is the service name, while the second is the object path. The object path we've used is defined by <a href="#mpris-spec">MPRIS</a>.<br>
      Try printing these attributes of <span class="inline-pre">player</span> -- <span class="inline-pre">bus_name</span> and <span class="inline-pre">requested_bus_name</span>
      <h3>Making method calls</h3>
      To make method calls, we call the method name directly on the object, giving it the associated interface name.<br>
      With <a href="#mpris-spec">MPRIS</a>, the interface <i>org.mpris.MediaPlayer2.Player</i> defines methods like <span class="inline-pre">Next()</span>, therefore to switch the track to the next in playlist, we call <span class="inline-pre">player.Next()</span> and set the <span class="inline-pre">dbus_interface</span> keyword argument as the interface
<pre>
&gt;&gt;&gt; player.Next(dbus_interface='org.mpris.MediaPlayer2.Player')
</pre>
      You should notice the track change.<br>
      Similarly we can call <span class="inline-pre">Previous(), Play(), Pause() or PlayPause()</span><br>
      But specifying the interface on each call is inconvenient, we can instead get an interface object once and rid ourselves of specifying it each time.
<pre>
&gt;&gt;&gt; interface = dbus.Interface(player, dbus_interface='org.mpris.MediaPlayer2.Player')
&gt;&gt;&gt; interface.Next()
&gt;&gt;&gt; interface.Previous()
&gt;&gt;&gt; interface.Pause()
&gt;&gt;&gt; interface.PlayPause() #Play if paused, pause if playing
</pre>
      Very straightforward, isn't it ?
      <h3>Properties</h3>
      We'll have to use the <i>org.freedesktop.DBus.Properties</i> interface to get the property.<br>
      This interface has three methods -- <span class="inline-pre">Get(), Set(), GetAll()</span> with which you can get or set the property in an interface.<br>
      Therefore to get a property in <i>org.mpris.MediaPlayer2.Player</i> interface, we call <span class="inline-pre">Get()</span> in <i>org.freedesktop.DBus.Properties</i> with the name of the interface and our property to retrieve it and <span class="inline-pre">Set()</span> to set it.<br>
      In python:
<pre>
&gt;&gt;&gt; volume = player.Get('org.mpris.MediaPlayer2.Player', 'Volume',
...             dbus_interface='org.freedesktop.DBus.Properties')
&gt;&gt;&gt; print(volume)
</pre>
      We can of course make an interface object to faciliate making frequent calls.
<pre>
&gt;&gt;&gt; property_interface = dbus.Interface(player, dbus_interface='org.freedesktop.DBus.Properties')
&gt;&gt;&gt; volume = property_interface.Get('org.mpris.MediaPlayer2.Player', 'Volume')
&gt;&gt;&gt; print(volume)
0.9
&gt;&gt;&gt; property_interface.Set('org.mpris.MediaPlayer2.Player', 'Volume', volume-0.2)
</pre>
      Here, we make an interface object, retrieve the volume (which is a value between 0.0 to 1.0) and in the last line,
      change the volume.<br>
      The <span class="inline-pre">GetAll()</span> method can be used print all the properties defined in an interface. e.g.
<pre>
&gt;&gt;&gt; for property, value in property_interface.GetAll('org.mpris.MediaPlayer2.Player').items():
...     print(property, ':', value)
</pre>
      You can see all the properties defined along with the  <i>Metadata</i> dictionary.
      <h3>Metadata</h3>
      A dictionary with <i>Metadata</i> of the current track playing can be obtained as below.
<pre>
&gt;&gt;&gt; metadata = player.Get('org.mpris.MediaPlayer2.Player', 'Metadata',
...             dbus_interface='org.freedesktop.DBus.Properties')
</pre>
      The peculiar thing about this dictionary is the naming system of the attributes.
      This is an example of it's contents:
<pre>
&gt;&gt;&gt; for attr, value in metadata.items():
...     print(attr, '\t', value)
...
xesam:contentCreated 	 2015-01-16T16:23:06
xesam:album 	 Radioactive
xesam:title 	 Radioactive
mpris:trackid 	 /org/mpris/MediaPlayer2/Track/165
xesam:useCount 	 2
mpris:artUrl 	 file:///tmp/clementine-art-yK1220.jpg
xesam:url 	 file:///home/amish/Music/Imagine Dragons/imagine-dragons---radioactive.mp3
mpris:length 	 185000000
xesam:trackNumber 	 1
xesam:autoRating 	 38
xesam:artist 	 dbus.Array([dbus.String('Imagine Dragons')], signature=dbus.Signature('s'), variant_level=1)
xesam:genre 	 dbus.Array([dbus.String('Blues')], signature=dbus.Signature('s'), variant_level=1)
bitrate 	 256
xesam:lastUsed 	 2015-06-09T13:27:53
</pre>
      The attribute name follows the <a href="http://www.freedesktop.org/wiki/Specifications/mpris-spec/metadata/">"Xesam ontology"</a>.
      Note that the <i>xesam:artist</i> and <i>xesam:genre</i> attributes above are <i>dbus arrays</i> which can used like python lists, these arrays will mostly have a singular item which can be accesed this way:
<pre>
&gt;&gt;&gt; print('Artist :\t', metadata['artist'][0])
Switchfoot
</pre>
      Note: Only the <span class="inline-pre">xesam:trackid</span> is guaranteed to exist in the metadata dictionary,
      so, accessing attributes should be done with a check whether it exists.
<pre>
&gt;&gt;&gt; print('Title :\t', metadata['xesam:title'] if 'xesam:title' in metadata else 'Unknown')
</pre>
      We used the ternary conditional operator to make it succint.<br>
      For more information on metadata, see the <a href="http://www.freedesktop.org/wiki/Specifications/mpris-spec/metadata/">MPRIS v2 metadata guidelines</a>
      <br>
      <h3>Conclusion</h3>
      Now, you should be able to make your own scripts or just use the interactive interpreter to control your media player. You can have a look at <a href="../Projects/source-code/mediaplayer.py">mediaplayer.py</a>, a python script I made which I use to print metadata in <a href="../Projects/conky-cards.html">conky</a> and make keybindings for clementine, which I was unable to do through clementine itself. For more information, see the D-Bus and MPRIS specifications in the references section below.
      <h3>References</h3>
      <ol>
        <li id="dbus-spec">Carlson, Herzberg, <i>et al.</i> "D-Bus Specification"<br>
          <a href="http://dbus.freedesktop.org/doc/dbus-specification.html">http://dbus.freedesktop.org/doc/dbus-specification.html</a></li>
        <li id="mpris-spec">The VideoLAN team, <i>et al.</i> "MPRIS D-Bus Interface Specification"<br>
          <a href="http://specifications.freedesktop.org/mpris-spec/latest">http://specifications.freedesktop.org/mpris-spec/latest</a></li>
        <li>McVittie, Simon "Dbus-python tutorial"<br>
          <a href="http://dbus.freedesktop.org/doc/dbus-python/doc/tutorial.html">http://dbus.freedesktop.org/doc/dbus-python/doc/tutorial.html</a></li>
      </ol>
    </div>
    <div id="footer">
      <a href="../index.html#contact">Contact Me</a><br><br>
      This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
    </div>
 </body>
</html>
