<!doctype html>
<html>
  <head>
    <title>xkcd shuffle -- Browse xkcd in a random order without clashes or duplicates</title>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="description" content="xkcd shuffle aims to fix the random button in xkcd. Browse xkcd in a random order, the order is saved between different sessions">
    <meta name="author" content="Amish Naidu">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-64115447-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="mersenne-twister.js"></script>
    <script>
      var comic_data;
      var total_comics;
      var container, message_div;
      var comic_list;
      var current_index = 0;
      var loading_message = "Loading...",
          error_message = "Couldn't load comic data :(\n" +
            "What has the black hat guy done now ?"
      function init()
      {
        container = document.getElementById('container');
        container.style.display = 'none';
        message_div = document.getElementById('message');
        message_div.style.display = 'block';
        message_div.innerHTML = loading_message;
        var seed = parseInt(get_cookie('seed')),
            comic = parseInt(get_cookie('comic'));
        if (!isNaN(seed))
        {
          document.getElementById('intro').style.display = 'none';
        }
        fetch("https://xkcd.com/info.0.json",
            function(){
              total_comics = comic_data.num;
              init_comic_list(seed, comic)
            }
          );
      }
      window.onload = init;
      function get_cookie(name)
      {
        var pattern = new RegExp(name + '\\s*\\=\\s*([^;]*)');
        var match = document.cookie.match(pattern);
        if (match)
          return match[1];
        return null;
      }
      function set_cookie(name, value)
      {
        document.cookie = name + '=' + value + '; expires=Fri, 1 Jan 2038 0:42:00 UTC';
      }
      function init_comic_list(seed, start)
      {
        if (typeof(seed) != 'number' || isNaN(seed))
        {
          /*Left shift works on 32 bit *signed* numbers,
            while <<< works on unsigned 32 bit numbers,
            therefore, doing a 0 shift gets us an *unsigned* 32 bit number*/
          seed = Math.floor(Math.random() * ((1 << 31) >>> 0));
        }
        document.getElementById('seed_box').value = seed;
        comic_list = get_random_list(seed, total_comics);
        if (typeof(start) != 'number' || isNaN(start))
          current_index = 0;
        else
          current_index = comic_list.indexOf(start) - 1;
        set_cookie('seed', seed);
        nav_random_comic(1);
      }
      //mt is an instance of MersenneTwister from mersenne-twister.js
      //Returns a random number *below* n i.e. in [0, n)
      function randbelow(mt, n)
      {
        log2 = Math.log2 || function(x) {
          return Math.log(x) / Math.LN2;
          };
        var bits = Math.floor(log2(n));
        var r = mt.genrand_int32() >> (32 - bits);
        while (r >= n)
          r = mt.genrand_int32() >> (32 - bits);
        return r;
      }
      function get_random_list(seed, end)
      {
        var mt =  new MersenneTwister(seed);
        var a = Array(end), j = 0;
        //Simple "in-place" fisher-yates shuffling
        for (var i = 0; i < end - 1; ++i)
        {
          j = randbelow(mt, i + 1);
          if (j != i)
            a[i] = a[j]
          a[j] = i + 1;
        }
        return a;
      }
      function nav_random_comic(dir)
      {
        if (typeof(dir) == 'undefined' || dir < 0)
        {
          --current_index;
          if (current_index < 0) current_index = total_comics - 1;
        }
        else
        {
          ++current_index;
          if (current_index >= total_comics) current_index = 0;
        }
        var url = "https://xkcd.com/" +
                  comic_list[current_index] +
                  "/info.0.json";
        container.style.display = 'none';
        message_div.style.display = 'block';
        message_div.innerHTML = loading_message;
        var img = container.getElementsByTagName('img')[0];
        fetch(url,
            function(){
              container.getElementsByTagName('h3')[0].innerHTML = comic_data.num +
                ': ' + comic_data.title;
              img.src = comic_data.img;
              img.title = comic_data.alt;
              container.getElementsByTagName('p')[0].innerHTML = 'Alt text: &ldquo;' + comic_data.alt + '&rdquo;';
              set_cookie('comic', comic_data.num);
            }
          );
      }
      function jsoncb(json)
      {
        if (json.query.count)
        {
          comic_data = json.query.results.json;
        }
        else
        {
          message_div.innerHTML = error_message;
        }
      }
      function fetch(url, callback)
      {
        if(typeof(callback) == 'function')
          cbwrapper = function(json){ jsoncb(json); callback(); };
        else
          cbwrapper = jsoncb;
        /*Use Yahoo! query language API to indirectly-
          access xkcd's json API because xkcd doesn't support JSONP*/
        var yql="select * " +
               " from json" +
               " where url='" + url + "';";
        yql = "http://query.yahooapis.com/v1/public/yql?q=" +
           encodeURIComponent(yql) +
           "&format=json" +
           "&callback=cbwrapper";
        var newscript = document.createElement('script');
        newscript.setAttribute('src', yql);
        newscript.setAttribute('id', 'json');
        head = document.getElementsByTagName('head')[0];
        head.replaceChild(newscript, document.getElementById('json'));
      }
      function comic_loaded()
      {
        container.style.display = 'block';
        message_div.style.display = 'none';
      }
    </script>
    <script id="json">
    </script>
  </head>
  <body>
    <div id="header">
      <h1>
        xkcd shuffle
      </h1>
      <br>
      <a href="http://amhndu.github.io" class="button">
        amhndu.github.io
      </a>
      <div id="navbar" style="display: none">
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="../projects.html" id="selected">Projects</a></li>
          <li><a href="../articles.html">Articles</a></li>
        </ul>
      </div>
      <br>
      <br>
    </div>
    <div id="content">
      <div style="background: #fafafa; border: 1px solid #ccc; padding: 0.5em" id="intro">
        xkcd shuffle lets you browse <a href="http://xkcd.com">xkcd</a> in a random order,
        without presenting the same comic multiple times.
        The order (and the current comic) is preserved between sessions and the order is determined only by the 'seed',
        so you can copy the seed to different browsers or devices to continue.<br><br>
        <a href="javascript:void(document.getElementById('intro').style.display='none');">Got it (close this box)</a>
      </div>
      <br><br>
      <div style="text-align: center;">
        Seed: <input type="text" id="seed_box">
        <button onclick="init_comic_list(parseInt(document.getElementById('seed_box').value))">Change Seed</button>
        <button onclick="init_comic_list()">New Random Seed</button>
        <br><br>
        <button onclick="nav_random_comic(-1)">Prev Random</button>
        <button onclick="nav_random_comic(1)">Next Random</button>
        <br><br>
        <div id="container">
          <h3></h3>
          <img onload="comic_loaded()">
          <br><br>
          <button onclick="
               a = document.getElementById('alt_text');
               a.style.display = (a.style.display != 'none') ? 'none' : 'block';
            ">Show/Hide Alt Text</button>
          <p id="alt_text" style="display: none;"></p>
        </div>
        <h3 id="message">
          Loading...
        </h3>
      </div>
      <a href="https://xkcd.com">xkcd by Randall Munroe</a>, is licensed under Creative Commmon BY-NC 2.5.<br>
      Disclaimer: This page is not associated with xkcd and is not responsible for the content.
    </div>
    <div id="footer">
      <a href="../index.html#contact">Contact Me</a><br><br>
      This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
    </div>
  </body>
</html>
