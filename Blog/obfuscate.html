<!doctype html>
<html>
  <head>
    <title>Let's make an obfuscated greeting!</title>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="description" content="Introduction to obfuscation in C where we make an obfuscated greeting.">
    <meta name="author" content="Amish Naidu">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300">
  </head>
  <body>
    <div id="header">
      <h1>
        Amish Naidu
      </h1>
      <div id="subtext">
        amhndu.me
      </div>
      <div id="navbar">
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="../projects.html">Projects</a></li>
          <li><a href="../blog.html" id="selected">Blog</a></li>
        </ul>
      </div>
    </div>
    <div id="content">
      <h2>Let's make an obfuscated greeting!</h2>
        <li type=none><B>Obfuscate:</B> tr.v. -cated, -cating, -cates.
        <ol><li type=1>
        <ol><li type=a>To render obscure.
        <LI type=a>To darken.
        </ol>
        <li type=1>To confuse: his emotions obfuscated his judgment.<br/>
        [LLat. obfuscare, to darken : ob(intensive) + Lat. fuscare,<br/>
        to darken &lt; fuscus, dark.] -obfuscation n. obfuscatory adj <sup>[1]</sup><br/>
        </ol>
        (taken from <a href="http://www.ioccc.org/">IOCCC</a>)
        <h3>The Why</h3>
            <ul type=none>
                <li>You learn lesser known aspects of the language</li>
                <li>Job security. Write obfuscated code and make sure no one else can maintain it but you! <small>Don't actually do dis</small></li>
                <li>It's fun. 'nuff said.</li>
            </ul>
        <h3>The Plan</h3>
            We'll be making a small C program which generates <a href="https://en.wikipedia.org/wiki/Sampling_(signal_processing)">samples</a> of a song (we'll stick with the 'Happy Birthday' song), which we'll play using <span class="inline-pre">aplay</span>, it comes along with ALSA (default on most Linux distributions). To follow along on macOS or Windows, you can install <a href="http://sox.sourceforge.net/">sox</a>.<br>
            We'll start with a non-obfuscated version and obfuscate it step-by-step.<br>
        <h3>The Code</h3>
        Here's the base we'll be obfuscating. It's commented, however understanding the sample generation isn't very important as long as you understand the outline.
        <pre><span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>stdio.h</span><span style='color:#800000; '>></span>

<span style='color:#400000; font-weight:bold; '>int</span> <span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>int</span> frequencies<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span><span style='color:#806030; '>=</span><span style='color:#806030; '>{</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>392</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>440</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>493</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>523</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>587</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>659</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>698</span><span style='color:#806030; '>,</span> <span style='color:#c00000; '>783</span><span style='color:#806030; '>}</span><span style='color:#806030; '>,</span> i<span style='color:#806030; '>,</span> j<span style='color:#806030; '>;</span>
    <span style='color:#c34e00; '>/* The Song.</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* @ maps to zero frequency, it comes right before A in ASCII, this makes mapping these notes to the frequency index trivial.</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
    <span style='color:#400000; font-weight:bold; '>char</span> song<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span> <span style='color:#806030; '>=</span> <span style='color:#800000; '>"</span><span style='color:#e60000; '>AABADC@AABAED@AAHFDCB@HHGDED</span><span style='color:#800000; '>"</span><span style='color:#806030; '>;</span>
    <span style='color:#400000; font-weight:bold; '>double</span> sample_rate <span style='color:#806030; '>=</span> <span style='color:#c00000; '>8000</span><span style='color:#806030; '>,</span>
           amplitude <span style='color:#806030; '>=</span> <span style='color:#c00000; '>128</span><span style='color:#806030; '>,</span>
           duration  <span style='color:#806030; '>=</span> <span style='color:#c00000; '>400</span><span style='color:#806030; '>;</span>   <span style='color:#c34e00; '>// in ms</span>

    <span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span>j <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span> j <span style='color:#806030; '>&lt;</span> <span style='color:#400000; font-weight:bold; '>sizeof</span><span style='color:#806030; '>(</span>song<span style='color:#806030; '>)</span><span style='color:#806030; '>/</span><span style='color:#400000; font-weight:bold; '>sizeof</span><span style='color:#806030; '>(</span>song<span style='color:#806030; '>[</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>]</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>j<span style='color:#806030; '>)</span>      <span style='color:#c34e00; '>// For each note in the song</span>
    <span style='color:#806030; '>{</span>
        <span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span> i <span style='color:#806030; '>&lt;</span> sample_rate <span style='color:#806030; '>*</span> duration <span style='color:#806030; '>/</span> <span style='color:#c00000; '>1000</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>)</span> <span style='color:#c34e00; '>// Print a sample</span>
        <span style='color:#806030; '>{</span>
            <span style='color:#c34e00; '>// Fade in/out sinusoidally</span>
            <span style='color:#400000; font-weight:bold; '>double</span> amp <span style='color:#806030; '>=</span> amplitude <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span>M_PI <span style='color:#806030; '>*</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>/</span> <span style='color:#806030; '>(</span>sample_rate <span style='color:#806030; '>*</span> duration <span style='color:#806030; '>/</span> <span style='color:#800000; '>1000.0</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
            <span style='color:#c34e00; '>/*</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* i samples   =>  (i / sample_rate) seconds</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* 1 second    =>  note_frequency wavelengths</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* Thus, (i / sample_rate) seconds =></span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;*       wavelengths = ((note_frequency * i) / sample_rate)</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* And, sample = sin ( 2 * PI * wavelengths)</span>
<span style='color:#c34e00; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
            <span style='color:#400000; font-weight:bold; '>int</span> frequency <span style='color:#806030; '>=</span> frequencies<span style='color:#806030; '>[</span>song<span style='color:#806030; '>[</span>j<span style='color:#806030; '>]</span> <span style='color:#806030; '>-</span> <span style='color:#008000; '>'@'</span><span style='color:#806030; '>]</span><span style='color:#806030; '>;</span>
            <span style='color:#400000; font-weight:bold; '>char</span> sample <span style='color:#806030; '>=</span>  <span style='color:#c00000; '>127</span> <span style='color:#806030; '>+</span> amp <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#806030; '>(</span><span style='color:#800000; '>2.0</span> <span style='color:#806030; '>*</span> M_PI <span style='color:#806030; '>*</span> i <span style='color:#806030; '>*</span> frequency<span style='color:#806030; '>)</span> <span style='color:#806030; '>/</span> sample_rate<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
            <span style='color:#800040; '>printf</span><span style='color:#806030; '>(</span><span style='color:#800000; '>"</span><span style='color:#007997; '>%c</span><span style='color:#800000; '>"</span><span style='color:#806030; '>,</span> sample<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
        <span style='color:#806030; '>}</span>
    <span style='color:#806030; '>}</span>
    <span style='color:#400000; font-weight:bold; '>return</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span>
<span style='color:#806030; '>}</span>
</pre>
        Run this (on Linux):
<pre>
gcc unobfuscated.c -w -lm &amp;&amp; ./a.out | aplay -f U8 -r 8000
</pre>
        If you're using sox:
<pre>
gcc unobfuscated.c -w -lm &amp;&amp; ./a.out | play -c 1 -b 8 -e unsigned -traw -r 8k -
</pre>
        Download <a href="">unobfuscated.c</a>.<br/>
        <h3>The Obfuscation</h3>
        First, let's substitute those space-wasting variables with <a href=https://en.wikipedia.org/wiki/Magic_number_(programming)>magic numbers</a>.<br>
        Then, we can just remove the include for stdio, it's still valid code. The compiler will assume the implicit definition for printf with return type int.<br>
        And during linking, the actual printf can just fit in here!<br>
        However, we can't do this with math.h, as the sin() function returns a double, which will cause a linker error.<br>
        In C, all global variables or functions without a given type are implicitly assumed to be int (or in case of functions, return type is int as remarked above).
        This lets us do
        <pre>_<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span><span style='color:#806030; '>=</span><span style='color:#806030; '>{</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>392</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>440</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>493</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>523</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>587</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>659</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>698</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>783</span><span style='color:#806030; '>}</span><span style='color:#806030; '>,</span>i<span style='color:#806030; '>,</span>j<span style='color:#806030; '>;</span>
<span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>.</span><span style='color:#806030; '>.</span><span style='color:#806030; '>.</span>
</pre>
        I also renamed the frequencies array to a <span class="inline-pre">_</span>. This greatly improves readability.
        Here's our inner loop:
        <pre><span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span> i <span style='color:#806030; '>&lt;</span> <span style='color:#c00000; '>3200</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>char</span> sample <span style='color:#806030; '>=</span>  <span style='color:#c00000; '>127</span> <span style='color:#806030; '>+</span> amplitude <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#800000; '>9.81e-4</span> <span style='color:#806030; '>*</span> i<span style='color:#806030; '>)</span> <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#806030; '>(</span><span style='color:#800000; '>7.85e-4</span> <span style='color:#806030; '>*</span> i <span style='color:#806030; '>*</span> _<span style='color:#806030; '>[</span>song<span style='color:#806030; '>[</span>j<span style='color:#806030; '>]</span> <span style='color:#806030; '>-</span> <span style='color:#008000; '>'@'</span><span style='color:#806030; '>]</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#800040; '>printf</span><span style='color:#806030; '>(</span><span style='color:#800000; '>"</span><span style='color:#007997; '>%c</span><span style='color:#800000; '>"</span><span style='color:#806030; '>,</span> sample<span style='color:#806030; '>)</span>;</span>
}</span>
</pre>
        We'll use another small C quirk.<br>
        <span class="inline-pre">A[i]</span> is equivalent to <span class="inline-pre">i[A]</span> where A can be any array-type or a pointer.<br>
        The array subscript is just syntactic sugar for pointer arithmatic.<br>
        <span class="inline-pre">A[i]</span> is essentially converted to <span class="inline-pre"><span style='color:#806030; '>*</span><span style='color:#806030; '>(</span>A <span style='color:#806030; '>+</span> i<span style='color:#806030; '>)</span></span>. Note that if you swap A and i in this form, it doesn't really make a difference. Instead of A here, we can put our song, which is a string. The string will decay to a pointer to the first element and we'll subsequently get the corresponding note.<br>
        Also, we see that <span class="inline-pre">@</span> has an ASCII value of 64, a power of 2. Observe that the minuend is always between 64 and 64 + 8 (eight is the total number of frequencies we can play). Instead of subtracting by 64, we can simply mask off the four lower bits to get the index.
        So
<pre>
<span style='color:#400000; font-weight:bold; '>int</span> frequency <span style='color:#806030; '>=</span> frequencies<span style='color:#806030; '>[</span>song<span style='color:#806030; '>[</span>j<span style='color:#806030; '>]</span> <span style='color:#806030; '>-</span> <span style='color:#008000; '>'@'</span><span style='color:#806030; '>]</span><span style='color:#806030; '>;</span>
</pre>
        becomes
<pre>_<span style='color:#806030; '>[</span>j<span style='color:#806030; '>[</span><span style='color:#800000; '>"</span><span style='color:#e60000; '>AABADC@AABAED@AAHFDCB@HHGDED</span><span style='color:#800000; '>"</span><span style='color:#806030; '>]</span><span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>15</span>
</pre>
        For the next obfuscation step, let's look at the program flow
<pre><span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span>j <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span> j <span style='color:#806030; '>&lt;</span> <span style='color:#c00000; '>28</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>j<span style='color:#806030; '>)</span>
    <span style='color:#806030; '>{</span>
        <span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span> i <span style='color:#806030; '>&lt;</span> <span style='color:#c00000; '>3200</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>)</span>
        <span style='color:#806030; '>{</span>
            <span style='color:#806030; '>.</span><span style='color:#806030; '>.</span><span style='color:#806030; '>.</span>
        <span style='color:#806030; '>}</span>
    <span style='color:#806030; '>}</span>
    <span style='color:#400000; font-weight:bold; '>return</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span>
<span style='color:#806030; '>}</span>
</pre>
        We can instead just use one loop and whenever we hit the end condition for i, we reset i and increment j.
        Something like:
<pre><span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>for</span> <span style='color:#806030; '>(</span><span style='color:#806030; '>;</span> j <span style='color:#806030; '>&lt;</span> <span style='color:#c00000; '>28</span><span style='color:#806030; '>;</span> <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>)</span>
    <span style='color:#806030; '>{</span>
        <span style='color:#806030; '>.</span><span style='color:#806030; '>.</span><span style='color:#806030; '>.</span>
        <span style='color:#400000; font-weight:bold; '>if</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>></span><span style='color:#806030; '>=</span> <span style='color:#c00000; '>3200</span><span style='color:#806030; '>)</span>
        <span style='color:#806030; '>{</span>
            i <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span>
            <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>j<span style='color:#806030; '>;</span>
        <span style='color:#806030; '>}</span>
    <span style='color:#806030; '>}</span>
<span style='color:#806030; '>}</span>
</pre>
        Making things better, let's just use recursion. With main.
<pre><span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
_<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span><span style='color:#806030; '>=</span><span style='color:#806030; '>{</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>392</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>440</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>493</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>523</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>587</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>659</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>698</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>783</span><span style='color:#806030; '>}</span><span style='color:#806030; '>,</span>i<span style='color:#806030; '>,</span>j<span style='color:#806030; '>;</span>
<span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>char</span> __ <span style='color:#806030; '>=</span>  <span style='color:#c00000; '>127</span> <span style='color:#806030; '>+</span> <span style='color:#c00000; '>128</span> <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#800000; '>9.81e-4</span> <span style='color:#806030; '>*</span> i<span style='color:#806030; '>)</span> <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#806030; '>(</span><span style='color:#800000; '>7.85e-4</span> <span style='color:#806030; '>*</span> i <span style='color:#806030; '>*</span> _<span style='color:#806030; '>[</span>j<span style='color:#806030; '>[</span><span style='color:#800000; '>"</span><span style='color:#e60000; '>AABADC@AABAED@AAHFDCB@HHGDED</span><span style='color:#800000; '>"</span><span style='color:#806030; '>]</span><span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>15</span><span style='color:#806030; '>]</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#800040; '>printf</span><span style='color:#806030; '>(</span><span style='color:#800000; '>"</span><span style='color:#007997; '>%c</span><span style='color:#800000; '>"</span><span style='color:#806030; '>,</span> __<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#400000; font-weight:bold; '>if</span> <span style='color:#806030; '>(</span>i <span style='color:#806030; '>></span><span style='color:#806030; '>=</span> <span style='color:#c00000; '>3200</span><span style='color:#806030; '>)</span>
    <span style='color:#806030; '>{</span>
        i <span style='color:#806030; '>=</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span>
        <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>j<span style='color:#806030; '>;</span>
    <span style='color:#806030; '>}</span>

    <span style='color:#400000; font-weight:bold; '>if</span> <span style='color:#806030; '>(</span>j <span style='color:#806030; '>&lt;</span> <span style='color:#c00000; '>28</span><span style='color:#806030; '>)</span>
    <span style='color:#806030; '>{</span>
        <span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>;</span>
        <span style='color:#400000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#806030; '>}</span>
    <span style='color:#400000; font-weight:bold; '>else</span>
        <span style='color:#400000; font-weight:bold; '>return</span> <span style='color:#c00000; '>0</span><span style='color:#806030; '>;</span>
<span style='color:#806030; '>}</span>
</pre>
        Those if blocks are quite verbose. Let's replace them with something more fun.<br>
        Real programmers use <a href="https://softwareengineering.stackexchange.com/a/201899">short circuit evaluation</a> not the ternary conditional operators or if blocks.
        Here's quick revision on short circuit evaluation:
<pre>
a &amp;&amp; b   -->  b will only be evaluated if a is true.  If a is false, we know the expression will be false anyway.
a || b   -->  b will only be evaluated if a is false. If a is true, the expression will be true regardless of b.
</pre>
        Talking about fun things, reminds of the less-used <a href="https://stackoverflow.com/a/52558">comma operator</a>.<br>
        How else can you code more readable than doing many things in one line ?<br><br>
        Another useful operator is the xor operator. It a useful property, for any a, <span class="inline-pre">a ^ a = 0</span><br>
        We can test equality with it: <span class="inline-pre">a == b</span> is equivalent to <span class="inline-pre">a ^ b</span>.<br>
        Zero a number: <span class="inline-pre">a ^= a</span>. In fact, this is a very common optimization, used by compilers and assembly programmers alike.<br>
        Putting it all together:
<pre><span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
_<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span><span style='color:#806030; '>=</span><span style='color:#806030; '>{</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>392</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>440</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>493</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>523</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>587</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>659</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>698</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>783</span><span style='color:#806030; '>}</span><span style='color:#806030; '>,</span>i<span style='color:#806030; '>,</span>j<span style='color:#806030; '>;</span>
<span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
<span style='color:#806030; '>{</span>
    <span style='color:#400000; font-weight:bold; '>char</span> __ <span style='color:#806030; '>=</span>  <span style='color:#c00000; '>127</span> <span style='color:#806030; '>+</span> <span style='color:#c00000; '>128</span> <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#800000; '>9.81e-4</span> <span style='color:#806030; '>*</span> i<span style='color:#806030; '>)</span> <span style='color:#806030; '>*</span> <span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#806030; '>(</span><span style='color:#800000; '>7.85e-4</span> <span style='color:#806030; '>*</span> i <span style='color:#806030; '>*</span> _<span style='color:#806030; '>[</span>j<span style='color:#806030; '>[</span><span style='color:#800000; '>"</span><span style='color:#e60000; '>AABADC@AABAED@AAHFDCB@HHGDED</span><span style='color:#800000; '>"</span><span style='color:#806030; '>]</span><span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>15</span><span style='color:#806030; '>]</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#800040; '>printf</span><span style='color:#806030; '>(</span><span style='color:#800000; '>"</span><span style='color:#007997; '>%c</span><span style='color:#800000; '>"</span><span style='color:#806030; '>,</span> __<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    i<span style='color:#806030; '>+</span><span style='color:#806030; '>+</span><span style='color:#806030; '>^</span><span style='color:#c00000; '>3200</span> <span style='color:#806030; '>|</span><span style='color:#806030; '>|</span> <span style='color:#806030; '>(</span>i<span style='color:#806030; '>^</span><span style='color:#806030; '>=</span>i<span style='color:#806030; '>,</span><span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>j<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
    <span style='color:#400000; font-weight:bold; '>return</span> <span style='color:#806030; '>(</span>j<span style='color:#806030; '>^</span><span style='color:#c00000; '>28</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>&amp;</span><span style='color:#806030; '>&amp;</span> <span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
<span style='color:#806030; '>}</span>
</pre>
        Not this looks like some obfuscation! But we're not done yet.<br>
        Instead of printf, we can use <a href="https://linux.die.net/man/2/write">write(2)</a>. If you were following on Windows, then I'm sorry you can't use this step.<br>The printf line becomes:
<pre>write<span style='color:#806030; '>(</span>STDIN<span style='color:#806030; '>,</span> <span style='color:#806030; '>&amp;</span>__<span style='color:#806030; '>,</span> <span style='color:#c00000; '>1</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>
</pre>
        Now we can strip all whitespace and make some minor tweaks to get this final version (run this the same way we ran the first unobfuscated version):
<pre><span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
_<span style='color:#806030; '>[</span><span style='color:#806030; '>]</span><span style='color:#806030; '>=</span><span style='color:#806030; '>{</span><span style='color:#c00000; '>0</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>392</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>440</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>493</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>523</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>587</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>659</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>698</span><span style='color:#806030; '>,</span><span style='color:#c00000; '>783</span><span style='color:#806030; '>}</span><span style='color:#806030; '>,</span>i<span style='color:#806030; '>,</span>j<span style='color:#806030; '>;</span>
<span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span><span style='color:#806030; '>{</span><span style='color:#400000; font-weight:bold; '>char</span> __<span style='color:#806030; '>=</span><span style='color:#c00000; '>127</span><span style='color:#806030; '>+</span><span style='color:#806030; '>(</span><span style='color:#c00000; '>1</span><span style='color:#806030; '>&lt;</span><span style='color:#806030; '>&lt;</span><span style='color:#c00000; '>7</span><span style='color:#806030; '>)</span><span style='color:#806030; '>*</span><span style='color:#800040; '>sin</span><span style='color:#806030; '>(</span><span style='color:#800000; '>9.81e-4</span><span style='color:#806030; '>*</span>j<span style='color:#806030; '>)</span><span style='color:#806030; '>*</span><span style='color:#800040; '>sin</span>
<span style='color:#806030; '>(</span><span style='color:#806030; '>(</span><span style='color:#800000; '>7.85e-4</span><span style='color:#806030; '>*</span>j<span style='color:#806030; '>*</span>_<span style='color:#806030; '>[</span>i<span style='color:#806030; '>[</span><span style='color:#800000; '>"</span><span style='color:#e60000; '>AABADC@AABAED@AAHFDCB@HHGD</span><span style='color:#0f6900; '>\</span><span style='color:#e60000; '></span>
<span style='color:#e60000; '>ED</span><span style='color:#800000; '>"</span><span style='color:#806030; '>]</span><span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>017</span><span style='color:#806030; '>]</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span>write<span style='color:#806030; '>(</span>__LINE__<span style='color:#806030; '>></span><span style='color:#806030; '>></span><span style='color:#c00000; '>0x2</span><span style='color:#806030; '>,</span><span style='color:#806030; '>&amp;</span>__<span style='color:#806030; '>,</span><span style='color:#806030; '>~</span><span style='color:#806030; '>*</span>_<span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>1</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span><span style='color:#806030; '>(</span>
j<span style='color:#806030; '>+</span><span style='color:#806030; '>+</span><span style='color:#806030; '>^</span><span style='color:#c00000; '>3200</span><span style='color:#806030; '>)</span><span style='color:#806030; '>|</span><span style='color:#806030; '>|</span><span style='color:#806030; '>(</span>j<span style='color:#806030; '>^</span><span style='color:#806030; '>=</span>j<span style='color:#806030; '>,</span><span style='color:#806030; '>+</span><span style='color:#806030; '>+</span>i<span style='color:#806030; '>)</span><span style='color:#806030; '>;</span><span style='color:#400000; font-weight:bold; '>return</span><span style='color:#806030; '>(</span>i<span style='color:#806030; '>^</span><span style='color:#c00000; '>28</span><span style='color:#806030; '>)</span><span style='color:#806030; '>&amp;</span><span style='color:#806030; '>&amp;</span><span style='color:#800000; font-weight:bold; '>main</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span><span style='color:#806030; '>;</span><span style='color:#806030; '>}</span>
</pre>
        These are the tweaks (most are to justify the text, some increase the line-width, some decrease):<br>
        Replaced 128 with (1 &lt;&lt; 7). See <a href="https://en.wikipedia.org/wiki/Bitwise_operation#Bit_shifts">Bit shifts</a>.<br>
        Replaced 15 with 017. Literals starting with a zero (not followed by an x) are in octal.<br>
        STDIN's fd is 1. The write call is in line 5, thus __LINE__ >> 2 evaluates to 5. As evident from the name, the macro __LINE__ expands to the line number.<br>
        For write()'s third arguemnt, we use the incantation
<pre><span style='color:#806030; '>~</span><span style='color:#806030; '>*</span>_<span style='color:#806030; '>&amp;</span><span style='color:#c00000; '>1</span>
</pre>
        First, _ is the frequencies array, decayed to the base pointer. We dereference it, thus we get the first element, which is 0.<br>
        Then we bitwise-negate it (~), we get a whole bunch of 1s which we finally bitwise-and with 1 which just yields 1.<br>
        This all works out thanks to the <a href="http://www.difranco.net/compsci/C_Operator_Precedence_Table.htm">C precedence rules</a>.<br>
        <br>
        And there you have it!<br>
        An awesome place for obfuscation is the IOCCC. Check out the previous winners, they are all mind-blowing.
        This was nowhere supposed to be the smallest or the most obfuscated program to do what it's doing. I'm sure people have done better.<br>
        But by making this, we sure learned a lot about C and broke into obfuscation.<br>
    </div>
    <div id="footer">
      <a href="../index.html#contact">Contact Me</a><br><br>
      This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
    </div>
 </body>
</html>
